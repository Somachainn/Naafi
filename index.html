<!DOCTYPE html>
<html lang="so">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Laam DEX Wallet</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/10.4.0/stellar-sdk.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
  :root{
    /* Blue & White Theme */
    --bg1:#eef2f3; --bg2:#8e9eab;
    --card:rgba(255, 255, 255, 0.9);
    --text:#0a192f; --muted:#546e7a;
    --brand:#0052cc; --brand2:#0041a3; --line: #d0d8e0;
    --ok:#28a745; --warn:#ffc107; --err:#dc3545;
    --maxw: 920px; --rad:16px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    color:var(--text);
    background: linear-gradient(135deg, var(--bg1), var(--bg2));
    min-height:100vh; display:flex; align-items:flex-start; justify-content:center; padding:24px 14px;
  }
  .app{ width:100%; max-width:var(--maxw); text-align:center; }
  .logo-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin-bottom: 18px;
  }
  .logo-container img {
      width: 50px;
      height: 50px;
  }
  h1{
    margin:0; font-size:2.2rem; font-weight:800; color:var(--brand);
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
  }
  .card{
    background: var(--card);
    border:1px solid var(--line);
    border-radius: var(--rad);
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    padding:22px;
    margin:14px auto;
  }
  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
  @media (max-width:820px){ .grid-2{ grid-template-columns:1fr; } }

  label{ display:block; text-align:left; margin:8px 0 6px; font-weight:600; color:var(--brand); }
  input, select, button{
    width:100%; padding:12px 14px; border:1px solid var(--line); border-radius:12px; font-size:1rem;
    background: #f8f9fa; color:var(--text); outline:none;
    transition: border-color .2s ease;
  }
  input:focus { border-color: var(--brand); }
  button{
    background: var(--brand); color:white; font-weight:700; letter-spacing:.02em;
    border:none; box-shadow: 0 4px 14px rgba(0, 82, 204, 0.3); cursor:pointer; text-transform:uppercase;
    transition: all .2s ease;
  }
  button:hover{ background:var(--brand2); box-shadow:0 6px 18px rgba(0, 65, 163, 0.4); transform: translateY(-2px); }
  button:disabled{ background:#b0bec5; cursor:not-allowed; box-shadow:none; transform: none; }
  .btn-secondary { background: #6c757d; color: white; box-shadow: 0 4px 14px rgba(0,0,0,0.1); }
  .btn-secondary:hover { background: #5a6268; }
  .btn-danger { background: var(--err); color: white; box-shadow: 0 4px 14px rgba(220, 53, 69, 0.3); }
  .btn-danger:hover { background: #c82333; }

  .mono{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    background:#e9ecef; padding:10px 12px; border-radius:12px;
    overflow-wrap:anywhere; word-break:break-word; color: #343a40;
  }
  #status{ min-height:28px; font-weight:700; color:var(--brand); }
  .muted{ color:var(--muted); font-size:.92rem; }
  .balances{ display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; }
  .pill{
    background:#e9ecef; border:1px solid var(--line);
    padding:8px 14px; border-radius:999px; font-weight:600; color: var(--text);
  }
  .hidden { display: none; }
  .send-wrap{ display:none; margin-top:16px; text-align:left; border-top: 1px solid var(--line); padding-top: 16px; }
  .send-row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  @media (max-width:640px){ .send-row{ grid-template-columns:1fr; } }

  /* New Trade UI Styles */
  .trade-card {
      padding: 0;
      overflow: hidden;
  }
  .trade-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--line);
  }
  .trade-header h3 {
      margin: 0;
      font-size: 1.2rem;
  }
  .trade-header .icon {
      font-size: 1.5rem;
      cursor: pointer;
  }
  .trade-asset-selector {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: #f8f9fa;
  }
  .asset-box {
      display: flex;
      align-items: center;
      gap: 8px;
  }
  .asset-box img { width: 24px; height: 24px; }
  .asset-box div { text-align: left; }
  .asset-box .asset-name { font-weight: 600; }
  .asset-box .asset-issuer { font-size: 0.8rem; color: var(--muted); }
  .swap-icon {
      font-size: 1.5rem;
      background: white;
      border-radius: 50%;
      padding: 5px;
      border: 1px solid var(--line);
      cursor: pointer;
  }
  .trade-tabs {
      display: flex;
      border-bottom: 1px solid var(--line);
  }
  .trade-tabs .tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      font-weight: 600;
      color: var(--muted);
      border-bottom: 3px solid transparent;
  }
  .trade-tabs .tab.active {
      color: var(--brand);
      border-bottom-color: var(--brand);
  }
  .orderbook-content {
      padding: 10px 20px 20px;
  }
  .orderbook-table {
      width: 100%;
      border-collapse: collapse;
  }
  .orderbook-table th, .orderbook-table td {
      text-align: right;
      padding: 8px 4px;
      font-size: 0.9rem;
  }
  .orderbook-table th {
      color: var(--muted);
      font-weight: normal;
  }
  .orderbook-table th:first-child, .orderbook-table td:first-child { text-align: left; }
  .orderbook-table .bid-row td:nth-child(2) { color: var(--ok); }
  .orderbook-table .ask-row td:nth-child(2) { color: var(--err); }
  .spread {
      padding: 12px 0;
      text-align: center;
      font-weight: bold;
      border-top: 1px solid var(--line);
      border-bottom: 1px solid var(--line);
      margin: 8px 0;
  }
  .trade-actions {
      display: flex;
      gap: 15px;
      padding: 20px;
      background: #f8f9fa;
      border-top: 1px solid var(--line);
  }
  .trade-actions button {
      flex: 1;
      padding: 14px;
      font-size: 1.1rem;
      border-radius: 12px;
      text-transform: uppercase;
  }
  .btn-buy { background-color: var(--ok); box-shadow: 0 4px 14px rgba(40, 167, 69, 0.3); }
  .btn-buy:hover { background-color: #218838; }
  .btn-sell { background-color: #e0e0e0; color: var(--text); box-shadow: 0 4px 14px rgba(0,0,0,0.1); }
  .btn-sell:hover { background-color: #d5d5d5; }
</style>
</head>
<body>
  <div class="app">
    <div class="logo-container">
        <img src="https://i.ibb.co/r28SP1bN/20250802-225108.png" alt="Laam Logo">
        <h1>Laam DEX Wallet</h1>
    </div>

    <!-- AUTHENTICATION SECTION -->
    <div id="authSection">
      <div class="card">
        <!-- Unlock View -->
        <div id="unlockView" class="hidden">
          <h3 style="margin:0 0 10px 0; color:var(--brand)">Unlock Wallet</h3>
          <label for="walletPassword">Password</label>
          <input id="walletPassword" type="password" placeholder="Enter your password" />
          <button id="unlockBtn" style="margin-top:10px;">Unlock</button>
          <p class="muted" style="margin-top:10px;"><a href="#" id="resetWalletLink">Reset and Import New Key</a></p>
        </div>

        <!-- Initial View -->
        <div id="initialView">
          <div class="grid-2">
            <!-- Create Wallet Section -->
            <div id="createWalletSection">
                <h3 style="margin:0 0 10px 0; color:var(--brand)">New User?</h3>
                <button id="showCreateWalletBtn">Create New Wallet</button>
                <div id="createWalletForm" class="hidden" style="margin-top:10px;">
                    <button id="generateAccountBtn">Generate New Stellar Account</button>
                    <label style="margin-top:10px;">New Secret Key</label>
                    <div id="newSecret" class="mono">-</div>
                    <label style="margin-top:10px;">New Public Key</label>
                    <div id="newPublic" class="mono">-</div>
                    <div class="muted" style="margin-top:6px;">
                        * Save your secret key securely!∆ meel amaan ah ki xifdi secret key gaaga<br>
                        
                      Copy your public wallet and deposit at least 2 XLM to open your wallet.
                    </div>
                </div>
            </div>
            <!-- Import Wallet Section -->
            <div>
              <h3 style="margin:0 0 10px 0; color:var(--brand)">Have a Wallet?</h3>
              <label>Enter Your Secret Key</label>
              <input id="secretKeyInput" type="password" placeholder="Starts with S..."/>
              <label style="margin-top:10px;">Create a Password to Save</label>
              <input id="savePasswordInput" type="password" placeholder="Min. 8 characters"/>
              <button id="importAndSaveBtn" style="margin-top:10px;">Import and Save</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- LOGGED IN VIEW -->
    <div id="loggedInView" class="hidden">
      <!-- Balances & Actions -->
      <div class="card">
        <div class="balances">
          <div class="pill">
            <div>XLM: <span id="xlmBal">0.00</span></div>
            <div class="muted" style="font-size:0.8rem;">$<span id="xlmUsd">0.00</span> ($<span id="xlmPrice">0.00</span>/XLM)</div>
          </div>
          <div class="pill">
            <div>Laam: <span id="laamBal">0.00</span></div>
            <div class="muted" style="font-size:0.8rem;">$<span id="laamUsd">0.00</span> ($<span id="laamPrice">0.06</span>/Laam)</div>
          </div>
        </div>
        <label style="margin-top:10px;">Your Public Key</label>
        <div id="pubKey" class="mono">-</div>
        <div style="display:flex; gap:10px; margin-top:16px; justify-content:center;">
            <button id="btnSendToggle">Send</button>
            <button id="addTrustlineBtn">Add Laam Trustline</button>
            <button id="logoutBtn" class="btn-danger">Lock Wallet</button>
        </div>
        <!-- Send Section -->
        <div id="sendForm" class="send-wrap">
            <h4 style="margin:0 0 10px 0; color:var(--brand)">Send Assets</h4>
            <div class="send-row">
              <div><label for="sendAsset">Asset</label><select id="sendAsset"><option value="XLM">XLM</option><option value="LAAM">Laam</option></select></div>
              <div><label for="sendAmount">Amount</label><input id="sendAmount" type="number" step="0.0000001" placeholder="e.g. 10" /></div>
            </div>
            <label for="sendDest" style="margin-top:8px;">Destination Public Key</label>
            <input id="sendDest" type="text" placeholder="G... destination" />
            <button id="btnSend" style="margin-top:10px;">Send Now</button>
        </div>
      </div>

      <!-- Trade Panels (Old, now hidden) -->
      <div class="card trade-panels grid-2" style="display:none;">
        <div>
          <h3>Buy Laam</h3>
          <label>Price (XLM/Laam)</label><input id="buyPrice" type="number" step="0.0000001" placeholder="e.g. 0.135" />
          <label>Amount (Laam)</label><input id="buyAmount" type="number" step="0.0000001" placeholder="e.g. 100" />
          <button id="btnPlaceBuy" style="margin-top:10px;">Place Buy</button>
        </div>
        <div>
          <h3>Sell Laam</h3>
          <label>Price (XLM/Laam)</label><input id="sellPrice" type="number" step="0.0000001" placeholder="e.g. 0.135" />
          <label>Amount (Laam)</label><input id="sellAmount" type="number" step="0.0000001" placeholder="e.g. 100" />
          <button id="btnPlaceSell" style="margin-top:10px;">Place Sell</button>
        </div>
      </div>

      <!-- New Trade UI -->
      <div class="card trade-card">
          <div class="trade-header">
              <span class="icon">←</span>
              <h3>Trade</h3>
              <span class="icon" onclick="loadOrderbook()">↻</span>
          </div>
          <div class="trade-asset-selector">
              <div class="asset-box">
                  <img src="https://i.ibb.co/r28SP1bN/20250802-225108.png" alt="Laam">
                  <div>
                      <div class="asset-name">Laam</div>
                      <div class="asset-issuer">laam.online</div>
                  </div>
              </div>
              <span class="swap-icon" id="swapAssets">⇄</span>
              <div class="asset-box">
                  <img src="https://res.coinpaper.com/coinpaper/stellar_xlm_logo_07021d63c0.png" alt="XLM">
                  <div>
                      <div class="asset-name">XLM</div>
                      <div class="asset-issuer">stellar.org</div>
                  </div>
              </div>
          </div>
          <div class="trade-tabs">
              <div class="tab" id="overviewTab">Overview</div>
              <div class="tab active" id="orderbookTab">Orderbook</div>
              <div class="tab" id="lastTradesTab">Last Trades</div>
          </div>
          <div class="orderbook-content" id="orderbookContent">
              <table class="orderbook-table">
                  <thead>
                      <tr>
                          <th>Amount (Laam)</th>
                          <th>Price (XLM)</th>
                          <th>Total (XLM)</th>
                      </tr>
                  </thead>
                  <tbody id="asksBody">
                      <!-- Asks (Sell offers) will be populated here -->
                  </tbody>
              </table>
              <div class="spread" id="spreadValue">0.13499</div>
              <table class="orderbook-table">
                  <tbody id="bidsBody">
                      <!-- Bids (Buy offers) will be populated here -->
                  </tbody>
              </table>
          </div>
          <div id="overviewContent" style="display:none; padding: 10px 20px 20px;">
            <div style="font-size: 2.5rem; font-weight: bold; text-align: center; margin-bottom: 10px;">0.13499 XLM</div>
            <div style="text-align: center; color: var(--muted); font-size: 0.9rem; margin-bottom: 20px;">Laam price August 14, 2025 04:51 AM</div>
            <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;">
              <button class="btn-secondary" style="flex: 0 1 auto; padding: 8px 15px; border-radius: 8px;">1D</button>
              <button class="btn-secondary" style="flex: 0 1 auto; padding: 8px 15px; border-radius: 8px;">1W</button>
              <button class="btn-secondary" style="flex: 0 1 auto; padding: 8px 15px; border-radius: 8px;">1M</button>
              <button class="btn-secondary" style="flex: 0 1 auto; padding: 8px 15px; border-radius: 8px;">1Y</button>
            </div>
            <div style="width: 100%; height: 200px; background-color: #f0f0f0; border-radius: 12px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; color: var(--muted);">[Graph Placeholder]</div>
            <div style="display: flex; justify-content: space-around; font-size: 0.8rem; color: var(--muted);">
              <span>3 AM</span><span>3 AM</span><span>3 AM</span><span>4 AM</span><span>4 AM</span><span>4 AM</span><span>4 AM</span>
            </div>
          </div>
          <div id="lastTradesContent" style="display:none; padding: 10px 20px 20px;">
            <p>This is the Last Trades content. A list of your recent trades will appear here.</p>
          </div>
          <div class="trade-actions">
              <button class="btn-buy" id="btnBuy">Buy</button>
              <button class="btn-sell" id="btnSell">Sell</button>
          </div>
      </div>
    </div>
  </div>

  <!-- Trade Modal -->
  <div id="tradeModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div class="card" style="max-width:400px; width:90%; padding:20px;">
      <h3 id="tradeModalTitle" style="margin-top:0; color:var(--brand);"></h3>
      <label for="tradeAmount">Amount (Laam)</label>
      <input id="tradeAmount" type="number" step="0.0000001" placeholder="e.g. 100" />
      <label for="tradePrice" style="margin-top:10px;">Price (XLM/Laam)</label>
      <input id="tradePrice" type="number" step="0.0000001" placeholder="e.g. 0.135" />
      <div style="display:flex; gap:10px; margin-top:20px;">
        <button id="confirmTradeBtn" style="flex:1;"></button>
        <button class="btn-secondary" style="flex:1;" onclick="closeTradeModal()">Cancel</button>
      </div>
    </div>
  </div>

<script>
// === SETUP ===
const server = new StellarSdk.Server("https://horizon.stellar.org");
const ISSUER = "GAL4ECDAXNBMJYFCWIJ32HKVIRLCNEXY664CAZYI3EINQWPLXTMEPR64";
const LAAM  = new StellarSdk.Asset("Laam", ISSUER);
const XLM   = StellarSdk.Asset.native();
const ENCRYPTED_KEY_NAME = "laam_dex_wallet_v4";

// === GLOBAL STATE ===
let keypair = null;
let account = null;
let balTimer = null;
let orderbookInterval = null;

// === UI ELEMENTS ===
const authSection = document.getElementById("authSection");
const loggedInView = document.getElementById("loggedInView");
const unlockView = document.getElementById("unlockView");
const initialView = document.getElementById("initialView");
const createWalletForm = document.getElementById("createWalletForm");
const statusEl = document.getElementById("status");
const bidsBody = document.getElementById("bidsBody");
const asksBody = document.getElementById("asksBody");
const spreadValue = document.getElementById("spreadValue");
const btnBuy = document.getElementById("btnBuy");
const btnSell = document.getElementById("btnSell");
const xlmUsdEl = document.getElementById("xlmUsd");
const xlmPriceEl = document.getElementById("xlmPrice");
const laamUsdEl = document.getElementById("laamUsd");
const laamPriceEl = document.getElementById("laamPrice");
const overviewTab = document.getElementById("overviewTab");
const orderbookTab = document.getElementById("orderbookTab");
const lastTradesTab = document.getElementById("lastTradesTab");
const overviewContent = document.getElementById("overviewContent");
const orderbookContent = document.getElementById("orderbookContent");
const lastTradesContent = document.getElementById("lastTradesContent");
const overviewLaamPriceEl = overviewContent.querySelector("div:first-child");
const overviewLaamPriceTimeEl = overviewContent.querySelector("div:nth-child(2)");

// === WALLET & ENCRYPTION ===
function encryptKey(secretKey, password) { return CryptoJS.AES.encrypt(secretKey, password).toString(); }
function decryptKey(encryptedKey, password) { const bytes = CryptoJS.AES.decrypt(encryptedKey, password); return bytes.toString(CryptoJS.enc.Utf8); }
function walletExists() { return !!localStorage.getItem(ENCRYPTED_KEY_NAME); }

// === UI LOGIC ===
function showView(viewName) {
  authSection.style.display = (viewName === "loggedIn") ? "none" : "block";
  loggedInView.style.display = (viewName === "loggedIn") ? "block" : "none";
  unlockView.style.display = (viewName === "unlock") ? "block" : "none";
  initialView.style.display = (viewName === "initial") ? "block" : "none";
}

function setStatus(msg, type = "ok") {
    console.log(`[${type.toUpperCase()}] ${msg}`);
    alert(msg); // Added alert for debugging
    statusEl.textContent = msg;
    statusEl.style.color = type === 'err' ? 'var(--err)' : 'var(--brand)';
}

function showTradeTab(tabName) {
    overviewTab.classList.remove("active");
    orderbookTab.classList.remove("active");
    lastTradesTab.classList.remove("active");

    overviewContent.style.display = "none";
    orderbookContent.style.display = "none";
    lastTradesContent.style.display = "none";

    if (tabName === "overview") {
        overviewTab.classList.add("active");
        overviewContent.style.display = "block";
    } else if (tabName ===orderbook") {
        orderbookTab.classList.add("active");
        orderbookContent.style.display = "block";
    } else if (tabName === "lastTrades") {
        lastTradesTab.classList.add("active");
        lastTradesContent.style.display = "block";
    }
}

// === CORE APP FUNCTIONS ===
async function login(secret) {
    console.log("Loading account...");
    setStatus("Loading account...");
    try {
        keypair = StellarSdk.Keypair.fromSecret(secret);
        account = await server.loadAccount(keypair.publicKey());
        document.getElementById("pubKey").textContent = keypair.publicKey();
        showView("loggedIn");
        setStatus("Account loaded successfully.");
        await refreshBalances();
        await loadOrderbook();
        if (balTimer) clearInterval(balTimer);
        balTimer = setInterval(refreshBalances, 15000);
        if (orderbookInterval) clearInterval(orderbookInterval);
        orderbookInterval = setInterval(loadOrderbook, 10000); // Refresh orderbook every 10 seconds
    } catch (e) {
        keypair = null; account = null;
        const errMsg = e.message.includes("404") ? "Account not found. Fund it with XLM to activate." : "Could not load account. Check your key.";
        setStatus(errMsg, 'err');
        showView(walletExists() ? "unlock" : "initial");
    }
}

function logout() {
    keypair = null; account = null;
    if (balTimer) clearInterval(balTimer);
    if (orderbookInterval) clearInterval(orderbookInterval);
    document.getElementById("walletPassword").value = "";
    showView(walletExists() ? "unlock" : "initial");
}

async function refreshBalances() {
    if (!keypair) return;
    try {
        account = await server.loadAccount(keypair.publicKey());
        const xlmBalance = account.balances.find(b => b.asset_type === "native");
        const laamBalance = account.balances.find(b => b.asset_code === "Laam" && b.asset_issuer === ISSUER);

        document.getElementById("xlmBal").textContent = xlmBalance ? parseFloat(xlmBalance.balance).toFixed(2) : "0.00";
        document.getElementById("laamBal").textContent = laamBalance ? parseFloat(laamBalance.balance).toFixed(2) : "0.00";

        // Fetch XLM to USD price from CoinGecko
        const response = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=stellar&vs_currencies=usd");
        const data = await response.json();
        const xlmUsdPrice = data.stellar.usd;

        xlmPriceEl.textContent = xlmUsdPrice.toFixed(2);
        xlmUsdEl.textContent = (parseFloat(document.getElementById("xlmBal").textContent) * xlmUsdPrice).toFixed(2);

        // Update Laam USD value based on current Laam/XLM price and XLM/USD price
        const currentLaamXlmPrice = parseFloat(laamPriceEl.textContent); // Get current Laam/XLM price from UI
        laamUsdEl.textContent = (parseFloat(document.getElementById("laamBal").textContent) * currentLaamXlmPrice * xlmUsdPrice).toFixed(2);

    } catch (e) {
        console.error("Error refreshing balances:", e);
        setStatus("Error refreshing balances.", 'err');
    }
}

async function loadOrderbook() {
    try {
        const orderbook = await server.orderbook(XLM, LAAM).call();

        // Clear existing rows
        asksBody.innerHTML = "";
        bidsBody.innerHTML = "";

        // Populate asks (sell offers of Laam for XLM)
        if (orderbook.asks.length > 0) {
            orderbook.asks.forEach(ask => {
                const row = asksBody.insertRow();
                row.classList.add("ask-row");
                row.insertCell().textContent = parseFloat(ask.amount).toFixed(2);
                row.insertCell().textContent = parseFloat(ask.price).toFixed(6);
                row.insertCell().textContent = (parseFloat(ask.amount) * parseFloat(ask.price)).toFixed(6);
            });
        } else {
            const row = asksBody.insertRow();
            const cell = row.insertCell();
            cell.colSpan = 3;
            cell.textContent = "No sell offers";
            cell.style.textAlign = "center";
        }

        // Populate bids (buy offers of Laam with XLM)
        if (orderbook.bids.length > 0) {
            orderbook.bids.forEach(bid => {
                const row = bidsBody.insertRow();
                row.classList.add("bid-row");
                row.insertCell().textContent = parseFloat(bid.amount).toFixed(2);
                row.insertCell().textContent = parseFloat(bid.price).toFixed(6);
                row.insertCell().textContent = (parseFloat(bid.amount) * parseFloat(bid.price)).toFixed(6);
            });
            // Update Laam price based on the highest bid (best price to sell Laam)
            const highestBidPrice = parseFloat(orderbook.bids[0].price);
            laamPriceEl.textContent = highestBidPrice.toFixed(6);
            overviewLaamPriceEl.textContent = `${highestBidPrice.toFixed(6)} XLM`;
            overviewLaamPriceTimeEl.textContent = `Laam price ${new Date().toLocaleString()}`;

        } else {
            const row = bidsBody.insertRow();
            const cell = row.insertCell();
            cell.colSpan = 3;
            cell.textContent = "No buy offers";
            cell.style.textAlign = "center";
            // If no bids, set Laam price to default or N/A
            laamPriceEl.textContent = "N/A";
            overviewLaamPriceEl.textContent = "N/A XLM";
            overviewLaamPriceTimeEl.textContent = `Laam price ${new Date().toLocaleString()}`;
        }

        // Calculate and display spread
        if (orderbook.asks.length > 0 && orderbook.bids.length > 0) {
            const bestAsk = parseFloat(orderbook.asks[0].price);
            const bestBid = parseFloat(orderbook.bids[0].price);
            spreadValue.textContent = (bestAsk - bestBid).toFixed(6);
        } else {
            spreadValue.textContent = "N/A";
        }

    } catch (e) {
        console.error("Error loading orderbook:", e);
        setStatus("Error loading orderbook.", 'err');
    }
}

// === EVENT LISTENERS ===
document.addEventListener("DOMContentLoaded", () => {
    if (walletExists()) {
        showView("unlock");
    } else {
        showView("initial");
    }

    // Authentication Section Listeners
    document.getElementById("unlockBtn").addEventListener("click", async () => {
        const password = document.getElementById("walletPassword").value;
        const encryptedKey = localStorage.getItem(ENCRYPTED_KEY_NAME);
        try {
            const secret = decryptKey(encryptedKey, password);
            await login(secret);
        } catch (e) {
            setStatus("Incorrect password or corrupted key.", 'err');
        }
    });

    document.getElementById("resetWalletLink").addEventListener("click", (e) => {
        e.preventDefault();
        if (confirm("Are you sure you want to reset your wallet? This will delete your saved key.")) {
            localStorage.removeItem(ENCRYPTED_KEY_NAME);
            setStatus("Wallet reset. Please create or import a new one.");
            showView("initial");
        }
    });

    document.getElementById("showCreateWalletBtn").addEventListener("click", () => {
        createWalletForm.classList.remove("hidden");
        document.getElementById("showCreateWalletBtn").style.display = "none";
    });

    document.getElementById("generateAccountBtn").addEventListener("click", () => {
        const newKeypair = StellarSdk.Keypair.random();
        document.getElementById("newSecret").textContent = newKeypair.secret();
        document.getElementById("newPublic").textContent = newKeypair.publicKey();
        setStatus("New account generated. Fund it with XLM to activate.");
    });

    document.getElementById("importAndSaveBtn").addEventListener("click", async () => {
        const secretKey = document.getElementById("secretKeyInput").value;
        const savePassword = document.getElementById("savePasswordInput").value;

        if (!secretKey || !savePassword) {
            setStatus("Please enter both secret key and password.", 'err');
            return;
        }
        if (savePassword.length < 8) {
            setStatus("Password must be at least 8 characters.", 'err');
            return;
        }

        try {
            // Validate secret key
            StellarSdk.Keypair.fromSecret(secretKey);
            const encrypted = encryptKey(secretKey, savePassword);
            localStorage.setItem(ENCRYPTED_KEY_NAME, encrypted);
            setStatus("Wallet imported and saved successfully!");
            await login(secretKey);
        } catch (e) {
            setStatus("Invalid secret key.", 'err');
        }
    });

    // Logged In Section Listeners
    document.getElementById("logoutBtn").addEventListener("click", logout);

    document.getElementById("btnSendToggle").addEventListener("click", () => {
        const sendForm = document.getElementById("sendForm");
        sendForm.style.display = sendForm.style.display === "block" ? "none" : "block";
    });

    document.getElementById("addTrustlineBtn").addEventListener("click", async () => {
        if (!account) { setStatus("Please log in first.", 'err'); return; }
        setStatus("Adding trustline...");
        try {
            const transaction = new StellarSdk.TransactionBuilder(account, {
                fee: StellarSdk.BASE_FEE
            })
            .addOperation(StellarSdk.Operation.changeTrust({
                asset: LAAM,
                limit: StellarSdk.Asset.MAX_INT64
            }))
            .setTimeout(30)
            .build();

            transaction.sign(keypair);
            const result = await server.submitTransaction(transaction);
            console.log("Trustline added:", result);
            setStatus("Laam trustline added successfully!");
            await refreshBalances();
        } catch (e) {
            console.error("Error adding trustline:", e);
            setStatus("Error adding trustline. Make sure you have enough XLM for fees.", 'err');
        }
    });

    document.getElementById("btnSend").addEventListener("click", async () => {
        if (!account) { setStatus("Please log in first.", 'err'); return; }
        setStatus("Sending transaction...");

        const sendAssetType = document.getElementById("sendAsset").value;
        const sendAmount = document.getElementById("sendAmount").value;
        const sendDest = document.getElementById("sendDest").value;

        if (!sendAmount || !sendDest) {
            setStatus("Please enter amount and destination.", 'err');
            return;
        }

        let assetToSend;
        if (sendAssetType === "XLM") {
            assetToSend = XLM;
        } else if (sendAssetType === "LAAM") {
            assetToSend = LAAM;
        } else {
            setStatus("Invalid asset selected.", 'err');
            return;
        }

        try {
            const transaction = new StellarSdk.TransactionBuilder(account, {
                fee: StellarSdk.BASE_FEE
            })
            .addOperation(StellarSdk.Operation.payment({
                destination: sendDest,
                asset: assetToSend,
                amount: sendAmount
            }))
            .setTimeout(30)
            .build();

            transaction.sign(keypair);
            const result = await server.submitTransaction(transaction);
            console.log("Transaction successful:", result);
            setStatus("Transaction sent successfully!");
            await refreshBalances();
        } catch (e) {
            console.error("Error sending transaction:", e);
            setStatus("Error sending transaction. Check destination and balance.", 'err');
        }
    });

    // Trade UI Listeners
    overviewTab.addEventListener("click", () => showTradeTab("overview"));
    orderbookTab.addEventListener("click", () => showTradeTab("orderbook"));
    lastTradesTab.addEventListener("click", () => showTradeTab("lastTrades"));

    // Initial tab display
    showTradeTab("orderbook"); // Default to orderbook as it was active in the original HTML

    // Trade Modal Logic
    const tradeModal = document.getElementById("tradeModal");
    const tradeModalTitle = document.getElementById("tradeModalTitle");
    const tradeAmountInput = document.getElementById("tradeAmount");
    const tradePriceInput = document.getElementById("tradePrice");
    const confirmTradeBtn = document.getElementById("confirmTradeBtn");

    function openTradeModal(type) {
        tradeModal.style.display = "flex";
        tradeModalTitle.textContent = `${type} Laam`;
        confirmTradeBtn.textContent = type;
        confirmTradeBtn.className = type === "Buy" ? "btn-buy" : "btn-sell";
        confirmTradeBtn.onclick = () => confirmTrade(type);
    }

    function closeTradeModal() {
        tradeModal.style.display = "none";
        tradeAmountInput.value = "";
        tradePriceInput.value = "";
    }

    async function confirmTrade(type) {
        if (!account) { setStatus("Please log in first.", 'err'); closeTradeModal(); return; }
        setStatus(`Placing ${type} order...`);

        const amount = tradeAmountInput.value;
        const price = tradePriceInput.value;

        if (!amount || !price) {
            setStatus("Please enter amount and price.", 'err');
            return;
        }

        try {
            let operation;
            if (type === "Buy") {
                operation = StellarSdk.Operation.manageBuyOffer({
                    selling: XLM,
                    buying: LAAM,
                    buyAmount: amount,
                    price: price,
                    offerId: 0 // 0 for new offer
                });
            } else {
                operation = StellarSdk.Operation.manageSellOffer({
                    selling: LAAM,
                    buying: XLM,
                    amount: amount,
                    price: price,
                    offerId: 0 // 0 for new offer
                });
            }

            const transaction = new StellarSdk.TransactionBuilder(account, {
                fee: StellarSdk.BASE_FEE
            })
            .addOperation(operation)
            .setTimeout(30)
            .build();

            transaction.sign(keypair);
            const result = await server.submitTransaction(transaction);
            console.log("Trade successful:", result);
            setStatus(`${type} order placed successfully!`);
            await refreshBalances();
            await loadOrderbook();
            closeTradeModal();
        } catch (e) {
            console.error("Error placing trade:", e);
            setStatus(`Error placing ${type} order.`, 'err');
        }
    }

    btnBuy.addEventListener("click", () => openTradeModal("Buy"));
    btnSell.addEventListener("click", () => openTradeModal("Sell"));

});
</script>
</body>
</html>
